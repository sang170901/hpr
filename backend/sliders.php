<?php
require __DIR__ . '/inc/db.php';
require __DIR__ . '/inc/auth.php';
require __DIR__ . '/inc/activity.php';
$pdo = getPDO();

$action = $_GET['action'] ?? '';
$id = isset($_GET['id']) ? (int)$_GET['id'] : 0;
$flash = ['type'=>'','message'=>''];

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    if (isset($_POST['save_slider'])) {
        $title = trim($_POST['title'] ?? '');
        $subtitle = trim($_POST['subtitle'] ?? '');
        $description = trim($_POST['description'] ?? '');
        $image = trim($_POST['image'] ?? '');
        $link = trim($_POST['link'] ?? '');
        $link_text = trim($_POST['link_text'] ?? '');
        $start_date = trim($_POST['start_date'] ?? null);
        $end_date = trim($_POST['end_date'] ?? null);
        $status = isset($_POST['status']) ? 1 : 0;
        $order = (int)($_POST['display_order'] ?? 0);
        try {
            if ($id) {
                $pdo->prepare('UPDATE sliders SET title=?,subtitle=?,description=?,image=?,link=?,link_text=?,start_date=?,end_date=?,status=?,display_order=? WHERE id=?')
                    ->execute([$title,$subtitle,$description,$image,$link,$link_text,$start_date,$end_date,$status,$order,$id]);
                log_activity($_SESSION['user']['id'] ?? null,'update_slider','slider',$id,null);
            } else {
                $pdo->prepare('INSERT INTO sliders (title,subtitle,description,image,link,link_text,start_date,end_date,status,display_order) VALUES (?,?,?,?,?,?,?,?,?,?)')
                    ->execute([$title,$subtitle,$description,$image,$link,$link_text,$start_date,$end_date,$status,$order]);
                $newId = $pdo->lastInsertId();
                log_activity($_SESSION['user']['id'] ?? null,'create_slider','slider',$newId,null);
            }
            header('Location: sliders.php?msg=' . urlencode('L∆∞u th√†nh c√¥ng') . '&t=success'); 
            exit;
        } catch (Exception $e) { 
            $flash['type']='error'; 
            $flash['message']='L·ªói: '.$e->getMessage(); 
        }
    }
}

if ($action==='delete' && $id) { 
    $pdo->prepare('DELETE FROM sliders WHERE id=?')->execute([$id]); 
    log_activity($_SESSION['user']['id'] ?? null,'delete_slider','slider',$id,null);
    header('Location: sliders.php?msg=' . urlencode('ƒê√£ x√≥a') . '&t=success'); 
    exit; 
}

// Get slider data for AJAX (JSON)
if ($action === 'get' && $id) {
    header('Content-Type: application/json');
    try {
        $stmt = $pdo->prepare('SELECT * FROM sliders WHERE id = ?');
        $stmt->execute([$id]);
        $slider = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if ($slider) {
            echo json_encode(['success' => true, 'slider' => $slider]);
        } else {
            echo json_encode(['success' => false, 'message' => 'Kh√¥ng t√¨m th·∫•y slider']);
        }
    } catch (Exception $e) {
        echo json_encode(['success' => false, 'message' => $e->getMessage()]);
    }
    exit;
}

require __DIR__ . '/inc/header.php';

// Get flash message from URL
if (isset($_GET['msg'])) {
    $flash['type'] = $_GET['t'] ?? 'success';
    $flash['message'] = $_GET['msg'];
}

$sliders = $pdo->query('SELECT * FROM sliders ORDER BY display_order ASC')->fetchAll(PDO::FETCH_ASSOC);
?>

<div class="card">
    <h2 class="page-main-title">Qu·∫£n l√Ω Banner/Slider</h2>
    
    <?php if(!empty($flash['message'])): ?>
        <div class="flash <?php echo $flash['type']==='success'?'success':'error' ?>">
            <?php echo htmlspecialchars($flash['message']) ?>
        </div>
    <?php endif; ?>
    
    <button class="small-btn primary" onclick="openAddModal()">+ Th√™m Slider</button>
    
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Ti√™u ƒë·ªÅ</th>
                <th>H√¨nh ·∫£nh</th>
                <th>Link</th>
                <th>Th·ª© t·ª±</th>
                <th>Th·ªùi gian</th>
                <th>Tr·∫°ng th√°i</th>
                <th>H√†nh ƒë·ªông</th>
            </tr>
        </thead>
        <tbody>
        <?php foreach($sliders as $s): ?>
            <tr>
<td><?php echo $s['id'] ?></td>
<td>
    <strong><?php echo htmlspecialchars($s['title']) ?></strong>
    <?php if(!empty($s['subtitle'])): ?><br><small><?php echo htmlspecialchars($s['subtitle']) ?></small><?php endif; ?>
</td>
<td><?php echo $s['image'] ? '<img src="../'.htmlspecialchars($s['image']).'" style="height:50px;border-radius:4px;" onerror="this.style.display=\'none\'">':'' ?></td>
<td>
    <?php if(!empty($s['link'])): ?>
        <a href="<?php echo htmlspecialchars($s['link']) ?>" target="_blank"><?php echo htmlspecialchars($s['link_text'] ?? 'Link') ?></a>
    <?php else: ?>
        <span style="color:#999;">Kh√¥ng c√≥</span>
    <?php endif; ?>
</td>
<td><?php echo $s['display_order'] ?></td>
<td>
    <?php if($s['start_date'] || $s['end_date']): ?>
        <?php echo $s['start_date'] ? date('d/m/Y', strtotime($s['start_date'])) : '‚àû' ?>
        -
        <?php echo $s['end_date'] ? date('d/m/Y', strtotime($s['end_date'])) : '‚àû' ?>
    <?php else: ?>
        <span style="color:#999;">Lu√¥n hi·ªÉn th·ªã</span>
    <?php endif; ?>
</td>
<td><?php echo $s['status'] ? '<span style="color:green;">‚úì Ho·∫°t ƒë·ªông</span>':'<span style="color:red;">‚úó T·∫°m d·ª´ng</span>' ?></td>
                <td class="btn-row">
                    <button class="small-btn" onclick="openEditModal(<?php echo $s['id'] ?>)">S·ª≠a</button>
                    <a class="small-btn warn" href="sliders.php?action=delete&id=<?php echo $s['id'] ?>" onclick="return confirm('X√≥a slider n√†y?')">X√≥a</a>
                </td>
            </tr>
        <?php endforeach; ?>
        <?php if(empty($sliders)): ?>
            <tr>
                <td colspan="8" style="text-align:center; color:#999; padding:40px;">
                    Ch∆∞a c√≥ slider n√†o. Nh·∫•n "Th√™m Slider" ƒë·ªÉ b·∫Øt ƒë·∫ßu.
                </td>
            </tr>
        <?php endif; ?>
        </tbody>
    </table>
</div>

<!-- Modal Th√™m Slider -->
<div id="addModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 style="margin:0">Th√™m Slider M·ªõi</h3>
            <span class="modal-close" onclick="closeAddModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form method="post" id="addSliderForm">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div>
                        <label>Ti√™u ƒë·ªÅ <span style="color:red">*</span>
                            <input type="text" name="title" id="add_title" required style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ph·ª• ƒë·ªÅ
                            <input type="text" name="subtitle" id="add_subtitle" style="width:100%">
                        </label>
                    </div>
                </div>

                <label style="margin-top:16px;">M√¥ t·∫£ ng·∫Øn
                    <textarea name="description" id="add_description" rows="3" style="width:100%"></textarea>
                </label>

                <label style="margin-top:16px;">URL H√¨nh ·∫£nh <span style="color:red">*</span>
                    <input type="text" name="image" id="add_image" required style="width:100%">
                </label>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
                    <div>
                        <label>Link ƒë√≠ch
                            <input type="text" name="link" id="add_link" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Text n√∫t Link
                            <input type="text" name="link_text" id="add_link_text" style="width:100%">
                        </label>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:16px">
                    <div>
                        <label>Th·ª© t·ª± hi·ªÉn th·ªã
                            <input type="number" name="display_order" id="add_display_order" value="0" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ng√†y b·∫Øt ƒë·∫ßu
                            <input type="date" name="start_date" id="add_start_date" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ng√†y k·∫øt th√∫c
                            <input type="date" name="end_date" id="add_end_date" style="width:100%">
                        </label>
                    </div>
                </div>

                <label style="margin-top:16px;display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" name="status" id="add_status" checked>
                    <span>K√≠ch ho·∫°t</span>
                </label>

                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
                    <button type="button" class="small-btn" onclick="closeAddModal()">H·ªßy</button>
                    <button type="submit" class="small-btn primary" name="save_slider">üíæ Th√™m slider</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal S·ª≠a Slider -->
<div id="editModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 style="margin:0">Ch·ªânh S·ª≠a Slider</h3>
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form method="post" id="editSliderForm" action="sliders.php?action=edit&id=">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                    <div>
                        <label>Ti√™u ƒë·ªÅ <span style="color:red">*</span>
                            <input type="text" name="title" id="edit_title" required style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ph·ª• ƒë·ªÅ
                            <input type="text" name="subtitle" id="edit_subtitle" style="width:100%">
                        </label>
                    </div>
                </div>

                <label style="margin-top:16px;">M√¥ t·∫£ ng·∫Øn
                    <textarea name="description" id="edit_description" rows="3" style="width:100%"></textarea>
                </label>

                <label style="margin-top:16px;">URL H√¨nh ·∫£nh <span style="color:red">*</span>
                    <input type="text" name="image" id="edit_image" required style="width:100%">
                </label>

                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
                    <div>
                        <label>Link ƒë√≠ch
                            <input type="text" name="link" id="edit_link" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Text n√∫t Link
                            <input type="text" name="link_text" id="edit_link_text" style="width:100%">
                        </label>
                    </div>
                </div>

                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:16px">
                    <div>
                        <label>Th·ª© t·ª± hi·ªÉn th·ªã
                            <input type="number" name="display_order" id="edit_display_order" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ng√†y b·∫Øt ƒë·∫ßu
                            <input type="date" name="start_date" id="edit_start_date" style="width:100%">
                        </label>
                    </div>
                    <div>
                        <label>Ng√†y k·∫øt th√∫c
                            <input type="date" name="end_date" id="edit_end_date" style="width:100%">
                        </label>
                    </div>
                </div>

                <label style="margin-top:16px;display:flex;align-items:center;gap:8px;cursor:pointer">
                    <input type="checkbox" name="status" id="edit_status">
                    <span>K√≠ch ho·∫°t</span>
                </label>

                <div style="margin-top:24px;display:flex;gap:12px;justify-content:flex-end">
                    <button type="button" class="small-btn" onclick="closeEditModal()">H·ªßy</button>
                    <button type="submit" class="small-btn primary" name="save_slider">üíæ L∆∞u thay ƒë·ªïi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function openAddModal() {
    document.getElementById('addModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    document.getElementById('addSliderForm').reset();
    document.getElementById('add_status').checked = true;
}

function closeAddModal() {
    document.getElementById('addModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

function openEditModal(sliderId) {
    document.getElementById('editModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    
    document.getElementById('editSliderForm').action = 'sliders.php?action=edit&id=' + sliderId;
    
    fetch('sliders.php?action=get&id=' + sliderId)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const s = data.slider;
                document.getElementById('edit_title').value = s.title || '';
                document.getElementById('edit_subtitle').value = s.subtitle || '';
                document.getElementById('edit_description').value = s.description || '';
                document.getElementById('edit_image').value = s.image || '';
                document.getElementById('edit_link').value = s.link || '';
                document.getElementById('edit_link_text').value = s.link_text || '';
                document.getElementById('edit_display_order').value = s.display_order || 0;
                document.getElementById('edit_start_date').value = s.start_date || '';
                document.getElementById('edit_end_date').value = s.end_date || '';
                document.getElementById('edit_status').checked = s.status == 1;
            } else {
                alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin slider!');
                closeEditModal();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('L·ªói khi t·∫£i d·ªØ li·ªáu!');
            closeEditModal();
        });
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

window.onclick = function(event) {
    const addModal = document.getElementById('addModal');
    const editModal = document.getElementById('editModal');
    
    if (event.target == addModal) closeAddModal();
    if (event.target == editModal) closeEditModal();
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeAddModal();
        closeEditModal();
    }
});
</script>

<?php require __DIR__ . '/inc/footer.php'; ?>
