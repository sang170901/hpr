<?php
require_once 'backend/inc/db.php';

echo "<h2>üîç Ki·ªÉm tra tr·∫°ng th√°i Slider</h2>";
echo "<style>body{font-family:Arial;padding:20px;background:#f5f5f5;} table{background:white;border-collapse:collapse;width:100%;} th,td{padding:12px;text-align:left;border:1px solid #ddd;} th{background:#38bdf8;color:white;} .active{color:green;font-weight:bold;} .inactive{color:red;font-weight:bold;}</style>";

try {
    $pdo = getPDO();
    $today = date('Y-m-d');
    
    echo "<h3>üìÖ Ng√†y hi·ªán t·∫°i: <strong>$today</strong></h3>";
    
    // L·∫•y T·∫§T C·∫¢ slider
    echo "<h3>üìã T·∫§T C·∫¢ SLIDER TRONG DATABASE</h3>";
    $allSliders = $pdo->query("SELECT * FROM sliders ORDER BY display_order ASC, id ASC")->fetchAll(PDO::FETCH_ASSOC);
    
    echo "<table>";
    echo "<tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th><th>Status</th><th>Start Date</th><th>End Date</th><th>Display Order</th><th>Hi·ªÉn th·ªã?</th></tr>";
    
    foreach ($allSliders as $slider) {
        $willDisplay = true;
        $reason = [];
        
        // Ki·ªÉm tra status
        if ($slider['status'] != 1) {
            $willDisplay = false;
            $reason[] = "Status = 0 (T·∫Øt)";
        }
        
        // Ki·ªÉm tra start_date
        if (!empty($slider['start_date']) && $slider['start_date'] > $today) {
            $willDisplay = false;
            $reason[] = "Ch∆∞a ƒë·∫øn ng√†y b·∫Øt ƒë·∫ßu";
        }
        
        // Ki·ªÉm tra end_date
        if (!empty($slider['end_date']) && $slider['end_date'] < $today) {
            $willDisplay = false;
            $reason[] = "ƒê√£ h·∫øt h·∫°n";
        }
        
        $statusText = $slider['status'] == 1 ? '<span class="active">‚úì Ho·∫°t ƒë·ªông</span>' : '<span class="inactive">‚úó T·∫Øt</span>';
        $displayText = $willDisplay ? '<span class="active">‚úì C√ì HI·ªÇN TH·ªä</span>' : '<span class="inactive">‚úó KH√îNG (' . implode(', ', $reason) . ')</span>';
        
        echo "<tr>";
        echo "<td>{$slider['id']}</td>";
        echo "<td>" . htmlspecialchars($slider['title']) . "</td>";
        echo "<td>$statusText</td>";
        echo "<td>" . ($slider['start_date'] ?: '<em>Kh√¥ng gi·ªõi h·∫°n</em>') . "</td>";
        echo "<td>" . ($slider['end_date'] ?: '<em>Kh√¥ng gi·ªõi h·∫°n</em>') . "</td>";
        echo "<td>{$slider['display_order']}</td>";
        echo "<td>$displayText</td>";
        echo "</tr>";
    }
    echo "</table>";
    
    // L·∫•y slider ACTIVE theo logic hi·ªán t·∫°i
    echo "<h3>‚úÖ SLIDER S·∫º HI·ªÇN TH·ªä TR√äN TRANG CH·ª¶ (theo logic getActiveSliders)</h3>";
    
    $sql = "SELECT * FROM sliders 
            WHERE status = 1 
            AND (start_date IS NULL OR start_date <= ?) 
            AND (end_date IS NULL OR end_date >= ?) 
            ORDER BY display_order ASC, id ASC";
    
    $stmt = $pdo->prepare($sql);
    $stmt->execute([$today, $today]);
    $activeSliders = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    if (empty($activeSliders)) {
        echo "<p style='padding:20px;background:#fef2f2;color:#dc2626;border:2px solid #fca5a5;border-radius:8px;'><strong>‚ö†Ô∏è KH√îNG C√ì SLIDER N√ÄO S·∫º HI·ªÇN TH·ªä!</strong><br>T·∫•t c·∫£ slider ƒë√£ b·ªã t·∫Øt ho·∫∑c kh√¥ng trong th·ªùi gian hi·ªÉn th·ªã.</p>";
    } else {
        echo "<p style='padding:20px;background:#f0fdf4;color:#059669;border:2px solid #86efac;border-radius:8px;'><strong>‚úì C√≥ " . count($activeSliders) . " slider s·∫Ω hi·ªÉn th·ªã</strong></p>";
        echo "<table>";
        echo "<tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th><th>Th·ª© t·ª±</th><th>H√¨nh ·∫£nh</th></tr>";
        foreach ($activeSliders as $slider) {
            echo "<tr>";
            echo "<td>{$slider['id']}</td>";
            echo "<td>" . htmlspecialchars($slider['title']) . "</td>";
            echo "<td>{$slider['display_order']}</td>";
            echo "<td>" . htmlspecialchars($slider['image']) . "</td>";
            echo "</tr>";
        }
        echo "</table>";
    }
    
    echo "<hr style='margin:30px 0;'>";
    echo "<p style='text-align:center;color:#666;'><a href='index.php' style='color:#38bdf8;'>‚Üê Quay v·ªÅ trang ch·ªß</a> | <a href='backend/sliders.php' style='color:#38bdf8;'>Qu·∫£n l√Ω Slider ‚Üí</a></p>";
    
} catch (Exception $e) {
    echo "<p style='color:red;'>L·ªói: " . $e->getMessage() . "</p>";
}
?>

