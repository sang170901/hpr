<?php
require_once 'backend/inc/db.php';

echo "<h2>üîç Ki·ªÉm Tra B√†i Vi·∫øt</h2>";
echo "<style>body{font-family:Arial;padding:20px;background:#f5f5f5;} table{background:white;border-collapse:collapse;width:100%;margin:20px 0;} th,td{padding:12px;text-align:left;border:1px solid #ddd;} th{background:#38bdf8;color:white;} .success{color:green;} .error{color:red;}</style>";

try {
    $pdo = getPDO();
    
    // Ki·ªÉm tra b·∫£ng c√≥ t·ªìn t·∫°i kh√¥ng
    echo "<h3>1. Ki·ªÉm tra b·∫£ng posts</h3>";
    try {
        $tables = $pdo->query("SHOW TABLES LIKE 'posts'")->fetchAll();
        if (count($tables) > 0) {
            echo "<p class='success'>‚úì B·∫£ng posts t·ªìn t·∫°i</p>";
        } else {
            echo "<p class='error'>‚úó B·∫£ng posts KH√îNG t·ªìn t·∫°i!</p>";
            echo "<p><a href='backend/scripts/create_posts_table.php'>‚Üí T·∫°o b·∫£ng posts</a></p>";
            exit;
        }
    } catch (Exception $e) {
        echo "<p class='error'>‚úó L·ªói: " . $e->getMessage() . "</p>";
        exit;
    }
    
    // ƒê·∫øm s·ªë b√†i vi·∫øt
    echo "<h3>2. S·ªë l∆∞·ª£ng b√†i vi·∫øt</h3>";
    $total = $pdo->query("SELECT COUNT(*) FROM posts")->fetchColumn();
    $published = $pdo->query("SELECT COUNT(*) FROM posts WHERE status = 'published'")->fetchColumn();
    $draft = $pdo->query("SELECT COUNT(*) FROM posts WHERE status = 'draft'")->fetchColumn();
    
    echo "<table>";
    echo "<tr><th>Tr·∫°ng th√°i</th><th>S·ªë l∆∞·ª£ng</th></tr>";
    echo "<tr><td><strong>T·ªïng c·ªông</strong></td><td><strong style='font-size:1.5em;color:#38bdf8;'>$total</strong></td></tr>";
    echo "<tr><td>Published</td><td style='color:green;font-weight:bold;'>$published</td></tr>";
    echo "<tr><td>Draft</td><td style='color:orange;'>$draft</td></tr>";
    echo "</table>";
    
    // Hi·ªÉn th·ªã danh s√°ch b√†i vi·∫øt
    echo "<h3>3. Danh s√°ch t·∫•t c·∫£ b√†i vi·∫øt</h3>";
    $posts = $pdo->query("SELECT id, title, category, status, created_at FROM posts ORDER BY id DESC")->fetchAll(PDO::FETCH_ASSOC);
    
    if (count($posts) > 0) {
        echo "<table>";
        echo "<tr><th>ID</th><th>Ti√™u ƒë·ªÅ</th><th>Danh m·ª•c</th><th>Tr·∫°ng th√°i</th><th>Ng√†y t·∫°o</th></tr>";
        foreach ($posts as $post) {
            $statusColor = $post['status'] == 'published' ? 'green' : 'orange';
            echo "<tr>";
            echo "<td>{$post['id']}</td>";
            echo "<td>" . htmlspecialchars($post['title']) . "</td>";
            echo "<td>" . htmlspecialchars($post['category']) . "</td>";
            echo "<td style='color:$statusColor;font-weight:bold;'>{$post['status']}</td>";
            echo "<td>{$post['created_at']}</td>";
            echo "</tr>";
        }
        echo "</table>";
    } else {
        echo "<p style='padding:40px;background:white;text-align:center;border-radius:10px;'>‚ùå Kh√¥ng c√≥ b√†i vi·∫øt n√†o trong database!</p>";
        echo "<p style='text-align:center;'><a href='backend/scripts/add_more_posts.php' style='display:inline-block;padding:15px 30px;background:#38bdf8;color:white;text-decoration:none;border-radius:10px;font-weight:bold;'>üìù Th√™m 10 B√†i Vi·∫øt</a></p>";
    }
    
    // Ki·ªÉm tra news.php ƒëang query nh∆∞ th·∫ø n√†o
    echo "<h3>4. Ki·ªÉm tra file news.php</h3>";
    if (file_exists('news.php')) {
        $newsContent = file_get_contents('news.php');
        if (strpos($newsContent, 'LIMIT') !== false) {
            preg_match('/LIMIT\s+(\d+)/', $newsContent, $matches);
            if (isset($matches[1])) {
                echo "<p>‚ö†Ô∏è File news.php c√≥ LIMIT = <strong style='color:red;font-size:1.2em;'>{$matches[1]}</strong></p>";
                echo "<p>‚Üí ƒê√¢y l√† l√Ω do ch·ªâ hi·ªÉn th·ªã {$matches[1]} b√†i!</p>";
            }
        } else {
            echo "<p>‚úì Kh√¥ng c√≥ LIMIT trong query</p>";
        }
    }
    
    echo "<hr>";
    echo "<p style='text-align:center;'>";
    echo "<a href='news.php' style='display:inline-block;padding:12px 24px;background:#059669;color:white;text-decoration:none;border-radius:8px;margin:10px;'>üì∞ Xem Trang Tin T·ª©c</a>";
    echo "<a href='backend/scripts/add_more_posts.php' style='display:inline-block;padding:12px 24px;background:#38bdf8;color:white;text-decoration:none;border-radius:8px;margin:10px;'>‚ûï Th√™m B√†i Vi·∫øt</a>";
    echo "</p>";
    
} catch (Exception $e) {
    echo "<p class='error'>‚úó L·ªói: " . $e->getMessage() . "</p>";
}
?>

